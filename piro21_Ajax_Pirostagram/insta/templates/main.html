{% extends 'base.html' %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <!-- 검색창 컨테이너 추가 -->
        <div class="search-wrapper">
            <div class="search-container">
                <input type="text" id="user-search" placeholder="유저 검색...">
                <div id="search-results"></div>
            </div>
            <div class="search-container">
                <input type="text" id="post-search" placeholder="게시물 검색...">
                <div id="post-search-results"></div>
            </div>
        </div>
        
        <!-- 로그아웃 버튼을 검색창 밑으로 이동 -->
        <div class="profile-image">
            {% if profile_user.profile_picture %}
                <img src="{{ profile_user.profile_picture.url }}" alt="Profile Picture" class="profile-pic">
            {% else %}
                <img src="/profile_pics/piro.png" alt="Default Profile Picture" class="profile-pic">
            {% endif %}
        </div>
        <div class="profile-info">
            <h2>{{ profile_user.username }}</h2>
            <div class="profile-actions">
                {% if user.is_authenticated %}
                    {% if user != profile_user %}
                        {% if is_following %}
                            <button class="unfollow-btn">언팔로우</button>
                        {% else %}
                            <button class="follow-btn">팔로우</button>
                        {% endif %}
                    {% endif %}
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="logout-btn">로그아웃</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="login-btn">로그인</a>
                    <a href="{% url 'signup' %}" class="signup-btn">회원가입</a>
                {% endif %}
            </div>
            <div class="profile-stats">
                <span><strong>{{ posts_count }}</strong> 게시물</span>
                <span><strong>{{ followers_count }}</strong> 팔로워</span>
                <span><strong>{{ following_count }}</strong> 팔로잉</span>
            </div>
            <p class="profile-bio">{{ profile_user.bio }}</p>
            {% if profile_user.website %}
                <a href="{{ profile_user.website }}" target="_blank" class="profile-website">{{ profile_user.website }}</a>
            {% endif %}
        </div>
    </div>

    {% if user.is_authenticated %}
        <a href="{% url 'insta:post_create' %}" class="create-post-btn">게시물 작성</a>
    {% endif %}
    <br>
    <div class="post-grid">
        {% for post in posts %}
        <div class="post-item">
            <a href="{% url 'insta:post_detail' post.id %}" class="post-link">
                <img src="{{ post.image.url }}" alt="Post Image">
                <div class="post-overlay">
                    <span class="post-likes">🖤 {{ post.likes.count }}</span>
                    <span class="post-comments">💬 {{ post.comments.count }}</span>
                </div>
            </a>
        </div>
        {% empty %}
        <p class="no-posts">아직 게시물이 없습니다.</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const likeCount = this.querySelector('.like-count');
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "insta:like_post" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    likeCount.textContent = response.likes_count;
                }
            };
            
            xhr.send('post_id=' + postId);
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('user-search');
    const searchResults = document.getElementById('search-results');

    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
            const query = searchInput.value.trim();
            if (query.length > 0) {
                searchUsers(query);
            } else {
                searchResults.innerHTML = '';
            }
        }, 300);
    });

    function searchUsers(query) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/search_users?q=${encodeURIComponent(query)}`, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status === 200) {
                const users = JSON.parse(xhr.responseText);
                displayResults(users);
            } else {
                searchResults.innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
            }
        };

        xhr.onerror = function() {
            searchResults.innerHTML = '<p>네트워크 오류가 발생했습니다.</p>';
        };

        xhr.send();
    }

    function displayResults(users) {
        if (users.length === 0) {
            searchResults.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
        }

        let html = '<ul>';
        users.forEach(function(user) {
            html += `<li>
                <img src="${user.profile_picture || '/profile_pics/piro.png'}" alt="${user.username}" class="search-result-pic">
                ${user.username}
            </li>`;
        });
        html += '</ul>';

        searchResults.innerHTML = html;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // 기존의 유저 검색 코드는 그대로 유지합니다.

    const postSearchInput = document.getElementById('post-search');
    const postSearchResults = document.getElementById('post-search-results');

    let postDebounceTimer;

    postSearchInput.addEventListener('input', function() {
        clearTimeout(postDebounceTimer);
        postDebounceTimer = setTimeout(function() {
            const query = postSearchInput.value.trim();
            if (query.length > 0) {
                searchPosts(query);
            } else {
                postSearchResults.innerHTML = '';
            }
        }, 300);
    });

    function searchPosts(query) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/search_posts?q=${encodeURIComponent(query)}`, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status === 200) {
                const posts = JSON.parse(xhr.responseText);
                displayPostResults(posts);
            } else {
                postSearchResults.innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
            }
        };

        xhr.onerror = function() {
            postSearchResults.innerHTML = '<p>네트워크 오류가 발생했습니다.</p>';
        };

        xhr.send();
    }

    function displayPostResults(posts) {
        if (posts.length === 0) {
            postSearchResults.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
        }

        let html = '<ul>';
        posts.forEach(function(post) {
            html += `<li>
                <img src="${post.image}" alt="Post Image" class="search-result-pic">
                <div>
                    <a href="/post/${post.id}">${post.caption.substring(0, 50)}${post.caption.length > 50 ? '...' : ''}</a>
                    <p>by ${post.user}</p>
                </div>
            </li>`;
        });
        html += '</ul>';

        postSearchResults.innerHTML = html;
    }
});
</script>
{% endblock %}
