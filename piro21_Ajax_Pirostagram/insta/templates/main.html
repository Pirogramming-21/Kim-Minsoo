{% extends 'base.html' %}

{% block content %}
<div class="profile-header">
    {% if profile_user.profile_picture %}
        <img src="{{ profile_user.profile_picture.url }}" alt="Profile Picture" class="profile-pic">
    {% else %}
        <img src="/profile_pics/piro.png" alt="Default Profile Picture" class="profile-pic">
    {% endif %}
    <h2>{{ profile_user.username }}</h2>
    <p>{{ profile_user.bio }}</p>
    {% if profile_user.website %}
        <a href="{{ profile_user.website }}" target="_blank">{{ profile_user.website }}</a>
    {% endif %}
    
    <div class="profile-stats">
        <span>게시물 {{ posts_count }}</span>
        <span>팔로워 {{ followers_count }}</span>
        <span>팔로잉 {{ following_count }}</span>
    </div>

    {% if user != profile_user %}
        {% if is_following %}
            <button class="unfollow-btn">언팔로우</button>
        {% else %}
            <button class="follow-btn">팔로우</button>
        {% endif %}
    {% endif %}
</div>

<div class="post-grid">
    <a href="{% url 'insta:post_create' %}">새 게시물 작성</a>
    {% for post in posts %}
    <div class="post-item">
        <a href="{% url 'insta:post_detail' post.id %}">
            <img src="{{ post.image.url }}" alt="Post Image">
        </a>
        <div class="post-info">
            <button class="like-button" data-post-id="{{ post.id }}">
                좋아요 <span class="like-count">{{ post.likes.count }}</span>
            </button>
            <p>{{ post.caption|truncatechars:100 }}</p>
        </div>
    </div>
    {% empty %}
    <p>아직 게시물이 없습니다.</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const likeCount = this.querySelector('.like-count');
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "insta:like_post" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    likeCount.textContent = response.likes_count;
                }
            };
            
            xhr.send('post_id=' + postId);
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
{% endblock %}