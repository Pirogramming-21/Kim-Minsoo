{% extends 'base.html' %}
{% load static %}

{% block content %}
  <a href="{% url 'ideas:idea_create' %}">아이디어 등록하기</a>

  <form method="get" action="{% url 'ideas:idea_list' %}">
    <select name="sort" class="form-select">
      <option value="likes" {% if request.GET.sort == 'likes' %}selected{% endif %}>찜한 순</option>
      <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>이름순</option>
      <option value="created" {% if request.GET.sort == 'created' %}selected{% endif %}>등록순</option>
      <option value="updated" {% if request.GET.sort == 'updated' %}selected{% endif %}>최신순</option>
    </select>
    <button type="submit" class="btn btn-primary">정렬</button>
  </form>

  <ul>
    {% for idea in ideas %}
      <li>
        <a href="{% url 'ideas:idea_detail' idea.id %}">
          <img src="{{ idea.image.url }}" alt="{{ idea.name }} 썸네일">
        </a>
        <ul>
          <li>
            찜:
            <button class="star-btn" data-idea-id="{{ idea.id }}">
              {% if idea.starred %}
                🌝
              {% else %}
                🌑
              {% endif %}
            </button>
          </li>
          <li>
            <a href="{% url 'ideas:idea_detail' idea.id %}">제목: {{ idea.name }}</a>
          </li>
          <li>예상 툴: {{ idea.expected_tools }}</li>
          <li>
            관심도: 
            <button class="interest-btn minus" data-idea-id="{{ idea.id }}" data-action="decrease">-</button>
            <span class="interest-value" data-idea-id="{{ idea.id }}">{{ idea.interest }}</span>
            <button class="interest-btn plus" data-idea-id="{{ idea.id }}" data-action="increase">+</button>
          </li>
        </ul>
      </li>
    {% endfor %}
  </ul>

  <script>
  document.querySelectorAll('.star-btn').forEach(button => {
    button.addEventListener('click', function() {
      const ideaId = this.dataset.ideaId;
      const isStarred = this.textContent.trim() === '🌝';

      fetch(`/ideas/${ideaId}/toggle-star/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ starred: !isStarred })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          this.textContent = data.starred ? '🌝' : '🌑';
        }
      })
      .catch(error => console.error('Error:', error));
    });

      // 관심도 조절 버튼 이벤트 리스너 추가
      document.querySelectorAll('.interest-btn').forEach(button => {
        button.addEventListener('click', function() {
          const ideaId = this.dataset.ideaId;
          const action = this.dataset.action;
          const valueSpan = document.querySelector(`.interest-value[data-idea-id="${ideaId}"]`);
          const currentValue = parseInt(valueSpan.textContent);

          fetch(`/ideas/${ideaId}/update-interest/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ action: action })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              console.log('Interest updated successfully:', data);
              valueSpan.textContent = data.new_value;
            } else {
              console.error('Failed to update interest:', data);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
        });
      });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
  </script>

{% endblock %}